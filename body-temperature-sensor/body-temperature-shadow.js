// Require AWS IoT Device SDK
const awsIoT = require('aws-iot-device-sdk');

// Require crypto for random numbers generation
const crypto = require('crypto');

// Load the endpoint from file
const endpointFile = require('/home/ec2-user/environment/endpoint.json');

// Fetch the deviceName from the folder name
const deviceName = __dirname.split('/').pop();

// Initial Get Client Token
let initialGetClientToken;

// Initial state of car
const initialState = {
    state: { 
        reported: { 
            isCharging: false
        }, 
        desired: null 
    }
};

// Create the thingShadow object with argument data
const deviceShadows = awsIoT.thingShadow({
   keyPath: 'private.pem.key',
  certPath: 'certificate.pem.crt',
    caPath: '/home/ec2-user/environment/root-CA.crt',
  clientId: deviceName,
      host: endpointFile.endpointAddress
});

// Register/Subscribe to the deviceShadows topic
deviceShadows.register(deviceName, {}, function(err, failedTopics) {
    if (isUndefined(err) && isUndefined(failedTopics)) {
        console.log('The ' + deviceName + ' has been registered.');
        initialGetClientToken = deviceShadows.get(deviceName);
    }
});

// On delta generated by IoT
deviceShadows.on('delta', function(deviceName, stateObject) {
    // If the attributes were modified, call the updateChargeStatus function
    if (!isUndefined(stateObject.state.isCharging)) {
        updateChargeStatus(stateObject.state.isCharging);
    }
    
    // Report to the Shadow the new state
    console.log('Reporting my new state.');
    deviceShadows.update(deviceName, { state: { reported: stateObject.state, desired: null } } );
});


// Function outputting the state of the Sensor
function updateChargeStatus(isPluggedIn) {
    console.log('My isCharging status: ' + isPluggedIn);
    isCharging = isPluggedIn;

}

// Function to look for undefined values
function isUndefined(value) {
    return typeof value === 'undefined' || value === null;
}

// On status when a get/update/delete is received
deviceShadows.on('status', function(deviceName, statusType, clientToken, stateObject) {
    // Resolving the initial state status. There could be no state, a delta state or a reported state
    
    // If the clientToken is for our initial Get request and the status is rejected
    //  this means that the Thing Shadow has been deleted. We need to set the state to defaults
    if (initialGetClientToken === clientToken && statusType === 'rejected') {   
        setDefaultState();
    }
    
    // If the clientToken is for our initial Get request and the status is accepted
    //  this means that there is a Shadow, but it may be empty
    if (initialGetClientToken === clientToken && statusType === 'accepted') {
        console.log('Received the initial get data.');
        
        // If the Thing Shadow is empty, set the state to defaults
        if (Object.keys(stateObject.state).length == 0) {
            setDefaultState();
        } 
        // Else if there is a delta state, resolve it
        else if (stateObject.state.hasOwnProperty('delta')) {
            console.log('Delta found on initial get setting params to that state and reporting.');
            
            // If the attributes were modified, call the updateChargeStatus function
            if (!isUndefined(stateObject.state.delta.isCharging)) {
                updateChargeStatus(stateObject.state.delta.isCharging);
            }
            
            // Report to the Shadow the new state
            deviceShadows.update(deviceName, { state: { reported: stateObject.state.delta, desired: null } } );
            
        } else {
            // If the state isn't empty and there is no delta, there is a reported state
            
            // If the attributes has been reported
            if (stateObject.state.reported.hasOwnProperty('isCharging')) {
                
                // A previously reported state has been found (probably from the previous run), set the state to that
                console.log('Found a previously reported state, setting my params to that');
                updateChargeStatus(stateObject.state.reported.isCharging);
            } else {
                
                // Else, we need to set the state to defaults
                setDefaultState();
            }
        }
    }
});

// Unregister the Shadow if the connection closes
deviceShadows.on('close', function() {
    console.log("close");
    console.log('The connection has been closed. Deregistering the Thing Shadow.');
      deviceShadows.unregister(deviceName);
});

// Set the state to defaults
function setDefaultState() {
    console.log('No state found, setting state to defaults.');
    deviceShadows.update(deviceName, initialState);
    updateChargeStatus(initialState.state.reported.isCharging);
}
